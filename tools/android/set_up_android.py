#!/usr/bin/python
import os, sys, shutil, collections
from optparse import OptionParser

def find_recursive(root, subpath, maxdepth=4):
  queue = collections.deque([(root, 0)])
  if 'PATH' in os.environ:
    envpath = os.environ['PATH'].split(':')
    relpath = ['..'] * (len(subpath) - 1)
    queue.extendleft([(os.path.join(x, *relpath), maxdepth) for x in envpath if 'android' in x.lower()])
  while len(queue) > 0:
    item = queue.popleft()
    if os.path.isfile(os.path.join(item[0], *subpath)):
      return os.path.abspath(item[0])
    if item[1] < maxdepth:
      for name in os.listdir(item[0]):
        fullname = os.path.join(item[0], name)
        if os.path.isdir(fullname) and '.' not in name:
          queue.append((fullname, item[1] + 1))
  return None

def read_local_properties():
  androidRoot = os.path.join(os.path.dirname(sys.argv[0]), '..', '..', 'android')
  propsFile = os.path.join(androidRoot, 'local.properties')
  sdkDir = None
  ndkDir = None
  if os.path.exists(propsFile):
    with open(propsFile, 'r') as f:
      for line in f:
        line = line.strip()
        if line.startswith('sdk.dir') and '=' in line:
          sdkDir = line.split('=')[1].strip()
        elif line.startswith('ndk.dir') and '=' in line:
          ndkDir = line.split('=')[1].strip()
  return (sdkDir, ndkDir)

def query_path(title, option, default, subpath):
  default = '' if not default else os.path.abspath(default)
  searchHint = ', "s" to search'
  while True:
    path = raw_input('Path to {0}{1} [{2}]:'.format(title, searchHint, default)) or default
    if len(searchHint) > 0 and path.lower().strip() == 's':
      found = find_recursive(os.path.expanduser('~'), subpath)
      if found:
        default = found
      searchHint = ''
    else:
      break
  test = os.path.join(path, *subpath)
  if path and os.path.isfile(test):
    return os.path.abspath(path)
  else:
    print 'Could not find {0}, not an {1} path.'.format(test, title)
    sys.exit(1)

def write_local_properties(sdkDir, ndkDir):
  content = ''.join([x + '\n' for x in [
      '# Autogenerated file',
      '# Do not add it to version control',
      'sdk.dir={0}'.format(sdkDir),
      'ndk.dir={0}'.format(ndkDir)
  ]])

  # Create omim/android/local.properties
  androidRoot = os.path.join(os.path.dirname(sys.argv[0]), '..', '..', 'android')
  propsFile = os.path.join(androidRoot, 'local.properties')
  print 'Writing {0}'.format(propsFile)
  with open(propsFile, 'w') as f:
    f.write(content)

  # Copy files to folders
  for folder in ['YoPme', 'YoPme2', 'UnitTests']:
    destFolder = os.path.join(androidRoot, folder)
    if not os.path.exists(destFolder):
      os.makedirs(destFolder)
    dst = os.path.join(destFolder, 'local.properties')
    print 'Copying to {0}'.format(dst)
    shutil.copy(propsFile, dst)

if __name__ == '__main__':
  parser = OptionParser()
  parser.add_option('-s', '--sdk', help='Path to Android SDK')
  parser.add_option('-n', '--ndk', help='Path to Android NDK')
  options, _ = parser.parse_args()

  sdkDir = options.sdk
  ndkDir = options.ndk

  if not options.sdk or not options.ndk:
    sdkDirOld, ndkDirOld = read_local_properties()
    if not sdkDir:
      sdkDir = sdkDirOld
    if not ndkDir:
      ndkDir = ndkDirOld
    sdkDir = query_path('Android SDK', options.sdk, sdkDir, ['platform-tools', 'adb'])
    ndkDir = query_path('Android NDK', options.ndk, ndkDir, ['ndk-build'])

  write_local_properties(sdkDir, ndkDir)
